name: Build Armbian Q9S RK3128 (Stable)

on:
  workflow_dispatch:
    inputs:
      release:
        description: "Debian release"
        required: true
        default: "bullseye"
        type: choice
        options:
          - bullseye
          - buster

env:
  ARMBIAN_VERSION: v22.11.4
  BOARD: q9s-rk3128

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # =============================
      # Free disk space
      # =============================
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/lib/android
          sudo apt-get clean
          df -h

      # =============================
      # Install dependencies
      # =============================
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git curl wget p7zip-full \
            qemu-user-static debootstrap \
            binfmt-support

      # =============================
      # Clone Armbian stable
      # =============================
      - name: Clone Armbian Build System
        run: |
          git clone --depth=1 \
            --branch=${{ env.ARMBIAN_VERSION }} \
            https://github.com/armbian/build.git armbian-build
          cd armbian-build
          git log -1 --oneline

      # =============================
      # Copy custom board config
      # =============================
      - name: Setup board config
        run: |
          mkdir -p armbian-build/config/boards

          cat > armbian-build/config/boards/q9s-rk3128.conf << 'EOF'
          BOARD_NAME="Q9S RK3128"
          BOARDFAMILY="rockchip"
          LINUXFAMILY="rockchip"
          ARCH="arm"
          KERNEL_TARGET="legacy"
          BOOTCONFIG="evb-rk3128_defconfig"
          EOF

      # =============================
      # Kernel config fragment
      # =============================
      - name: Add kernel config fragment
        run: |
          mkdir -p armbian-build/userpatches/kernel/rockchip-legacy

          cat > armbian-build/userpatches/kernel/rockchip-legacy/config-q9s.conf << 'EOF'
          CONFIG_LOCALVERSION="-q9s-rk3128"
          CONFIG_SMP=y
          CONFIG_NR_CPUS=4
          CONFIG_USB_EHCI_HCD=y
          CONFIG_USB_OHCI_HCD=y
          CONFIG_STMMAC_ETH=y
          EOF

      # =============================
      # Build Armbian
      # =============================
      - name: Build image
        run: |
          cd armbian-build

          ./compile.sh \
            BOARD=${{ env.BOARD }} \
            BRANCH=legacy \
            RELEASE=${{ github.event.inputs.release }} \
            BUILD_MINIMAL=yes \
            BUILD_DESKTOP=no \
            KERNEL_CONFIGURE=no \
            EXTRAWIFI=no \
            SHARE_LOG=yes \
            COMPRESS_OUTPUTIMAGE=sha,xz \
            EXPERT=yes

      # =============================
      # Collect artifacts
      # =============================
      - name: Collect artifacts
        if: always()
        run: |
          mkdir -p artifacts
          cp -v armbian-build/output/images/*.img.xz artifacts/ 2>/dev/null || true
          cp -v armbian-build/output/images/*.sha artifacts/ 2>/dev/null || true

      # =============================
      # Upload artifacts
      # =============================
      - name: Upload image
        uses: actions/upload-artifact@v4
        with:
          name: armbian-q9s-rk3128
          path: artifacts/*.img.xz
          if-no-files-found: warn

      - name: Upload checksum
        uses: actions/upload-artifact@v4
        with:
          name: checksum
          path: artifacts/*.sha
          if-no-files-found: warn

