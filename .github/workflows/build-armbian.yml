name: Build Armbian for Q9S RK3128

on:
  workflow_dispatch:
    inputs:
      release:
        description: 'Debian/Ubuntu release'
        required: true
        default: 'bookworm'
        type: choice
        options:
          - bookworm
          - bullseye
          - jammy
          - noble
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/build-armbian.yml'
      - 'userpatches/**'
      - 'config/**'

env:
  BOARD_NAME: q9s-rk3128

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Free up disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          
          # Remove unnecessary packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/swift
          
          # Clean apt cache
          sudo apt-get clean
          
          echo "=== Disk space after cleanup ==="
          df -h
      
      - name: Install Docker and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            curl \
            wget \
            p7zip-full \
            qemu-user-static \
            binfmt-support
      
      - name: Clone Armbian build system
        run: |
          git clone --depth=1 \
            https://github.com/armbian/build.git armbian-build
          
          echo "Using Armbian main branch"
          cd armbian-build && git log -1 --oneline
      
      - name: Setup custom board configuration
        run: |
          # Create boards directory if needed
          mkdir -p armbian-build/config/boards
          
          # Copy board config
          if [ -f config/boards/q9s-rk3128.wip ]; then
            cp -v config/boards/q9s-rk3128.wip armbian-build/config/boards/
          fi
          
          echo "=== Custom board configs ==="
          cat armbian-build/config/boards/q9s-rk3128.wip
      
      - name: Build Armbian image
        run: |
          cd armbian-build
          
          # Run build using new Armbian CLI syntax
          ./compile.sh build \
            BOARD=${{ env.BOARD_NAME }} \
            BRANCH=current \
            RELEASE=${{ github.event.inputs.release || 'bookworm' }} \
            BUILD_MINIMAL=yes \
            BUILD_DESKTOP=no \
            KERNEL_CONFIGURE=no \
            COMPRESS_OUTPUTIMAGE=sha,xz \
            EXPERT=yes \
            2>&1 | tee ../build.log
          
          echo "=== Build completed ==="
          ls -lah output/images/ || echo "No images found"
      
      - name: Prepare artifacts
        if: always()
        run: |
          mkdir -p artifacts
          
          # Copy images
          cp -v armbian-build/output/images/*.img* artifacts/ 2>/dev/null || true
          cp -v armbian-build/output/images/*.txt artifacts/ 2>/dev/null || true
          
          # Copy build log
          cp -v build.log artifacts/ 2>/dev/null || true
          
          # Create info file
          cat > artifacts/BUILD_INFO.txt << EOF
          Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Armbian Version: main
          Board: Q9S RK3128 (TXCZ-RK3128-V3.1)
          Release: ${{ github.event.inputs.release || 'bookworm' }}
          Kernel: 6.x (current)
          GitHub Run: ${{ github.run_id }}
          EOF
          
          echo "=== Artifacts ==="
          ls -lah artifacts/
      
      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: armbian-q9s-rk3128-image
          path: artifacts/*.img*
          retention-days: 30
          if-no-files-found: warn
      
      - name: Upload build info
        uses: actions/upload-artifact@v4
        with:
          name: build-info
          path: |
            artifacts/BUILD_INFO.txt
            artifacts/*.txt
          retention-days: 30
      
      - name: Upload build log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-log
          path: build.log
          retention-days: 7
      
      - name: Create GitHub Release
        if: success() && github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: "Armbian Q9S RK3128 - Build #${{ github.run_number }}"
          draft: false
          prerelease: false
          files: |
            artifacts/*.img.xz
            artifacts/BUILD_INFO.txt
          body: |
            ## ðŸŽ‰ Armbian Build for Q9S RK3128
            
            ### ThÃ´ng tin build
            | Item | Value |
            |------|-------|
            | **Board** | Q9S (TXCZ-RK3128-V3.1) |
            | **Release** | ${{ github.event.inputs.release || 'bookworm' }} |
            | **Kernel** | Linux 6.x (current) |
            | **Armbian** | main branch |
            
            ### HÆ°á»›ng dáº«n
            1. Download file `.img.xz`
            2. Giáº£i nÃ©n báº±ng 7-zip hoáº·c `xz -d`
            3. Flash báº±ng Balena Etcher hoáº·c dd
            
            ### âš ï¸ LÆ°u Ã½
            - Backup firmware gá»‘c trÆ°á»›c khi flash!
            - Kiá»ƒm tra SHA256 checksum sau khi download
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Board | Q9S RK3128 |" >> $GITHUB_STEP_SUMMARY
          echo "| Armbian | main branch |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ github.event.inputs.release || 'bookworm' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f artifacts/*.img.xz ]; then
            echo "âœ… Build succeeded!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build may have failed - check logs" >> $GITHUB_STEP_SUMMARY
          fi
